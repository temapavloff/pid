<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hello world</title>
    <link rel="stylesheet" href="/simple.min.css">
    <style>
        body {
            font-size: 1rem;
            display: initial;
        }

        main {
            padding-top: 0.5rem;
            display: grid;
            grid-template-columns: 50% 50%;
        }

        section {
            border: none;
        }

        table {
            margin-top: 0;
            background: none;
            border: none;
            width: 100%;
        }

        tr {
            background: none;
            border: none;
        }

        td {
            background: none;
            border: none;
            padding-top: 0.1rem;
            padding-bottom: 0.1rem;
        }

        .current_weather {
            font-size: 3em;
        }

        .weather_table td {
            text-align: center;
        }
    </style>
</head>

<body>
    <main>
        <section id="transport"></section>
        <section id="weather"></section>
    </main>
</body>

<script type="module">
    const getDeparture = (now, { short, predicted }) => {
        if (!predicted) {
            return short;
        }

        const predictedTimeStamp = Number(new Date(predicted));
        const minutes = Math.ceil((predictedTimeStamp - now) / (1000 * 60));

        if (minutes <= 0) {
            return null;
        }

        return String(minutes);
    };

    const mapTypeToEmoji = {
        metro: '🚇',
        tram: '🚋',
        bus: '🚌',
    };
    const getEmoji = (type) => mapTypeToEmoji[type] ?? '🤷‍♂️';

    const fetchDepartures = async () => {
        const response = await fetch('/api/departures', {
            headers: { 'Accept': 'application/json' }
        });

        if (!response.ok) {
            throw new Error('Someting went wrong');
        }

        return response.json();
    };

    const renderTransportTable = (stop) => {
        const now = Number(new Date());
        const rows = stop.routes.map(r => (`<tr>
            <td>${getEmoji(r.vehicleType)} ${r.isNight ? '🌙' : ''}</td>
            <td>${r.routeNumber} <small>(&rarr; ${r.direction})</small></td>
            <td>
                ${r.departures.map(d => getDeparture(now, d)).filter(d => d !== null).join(', ')}
            </td>
        </tr>`)).join('');

        return `<strong>${stop.stopName}</strong><br><table>${rows}</table>`;
    };

    const renderTransport = async () => {
        let content = '';
        try {
            const stops = await fetchDepartures();
            content = stops.map(renderTransportTable).join('\n');
        } catch (e) {
            content = `<h2>Ooops! ${e.message}.</h2>`;
        }

        document.querySelector('#transport').innerHTML = content;
    };

    renderTransport();

    setInterval(renderTransport, 1000 * 60);
</script>

<script type="module">
    const fetchWeather = async () => {
        const response = await fetch('/api/weather', {
            headers: { 'Accept': 'application/json' }
        });

        if (!response.ok) {
            throw new Error('Someting went wrong');
        }

        return response.json();
    };

    const mapWeatherCodesToEmoji = {
        clear: '☀️',
        partial_cloud: '🌤️',
        fog: '😶‍🌫️',
        drizzle: '💧',
        freezing_drizzle: '🧊',
        rain: '🌧️',
        freezing_rain: '🌧️🧊',
        snow_fall: '🌨️',
        snow_grains: '❄️',
        rain_showers: '🌧️🌧️',
        snow_showers: '🌨️🌨️',
        thunderstorm: '⛈️',
        thunderstorm_hail: '⛈️⛈️',
    };

    const mapPrecipitationToEmoji = {
        rain: '🌧️',
        showers: '🌧️🌧️',
        snowfall: '🌨️',
    };
    const getPrecipitationEmoji = (type) => mapPrecipitationToEmoji[type] ?? ' ';
    const windEmoji = '🌬️';

    const renderPrecipitation = (p) => {
        if (p.probability === 0) {
            return '☀️';
        }

        return `${getPrecipitationEmoji(p.type)} ${Math.ceil(p.probability * 100)}%`;
    };
    const rednerTime = (dt) => {
        const d = new Date(dt);
        let hours = d.getHours();
        if (hours < 10) {
            hours = `0${hours}`;
        }
        return `${hours}:00`;
    }
    const renderTemperature = (t) => {
        return Math.sign(t) * Math.ceil(Math.abs(t));
    }

    const renderWeather = async () => {
        let content = '';
        try {
            const weather = await fetchWeather();
            const current = `<tr>
                <td colspan="8" class="current_weather">
                    <strong>${renderTemperature(weather.current.temperature)}°</strong>
                    ${mapWeatherCodesToEmoji[weather.current.weatherCode]}
                    ${windEmoji} ${Math.ceil(weather.current.windSpeed)} m/s
                </td>
            </tr>`;
            const forecast = weather.forecast.map(f => (`<td>
                <small>${rednerTime(f.time)}</small> <br>
                <strong>${renderTemperature(f.temperature)}°</strong> <br>
                ${renderPrecipitation(f.precipitation)} <br>
                ${windEmoji} ${Math.ceil(f.windSpeed)} m/s
            </td>`)).join('');

            content = `<table class="weather_table">
                ${current}
                <tr>${forecast}</tr>
            </table>`;

            console.log(content);

        } catch (e) {
            content = `<h2>Ooops! ${e.message}.</h2>`;
        }

        document.querySelector('#weather').innerHTML = content;

    };

    renderWeather();

    setInterval(renderWeather, 1000 * 60 * 10);
</script>

</html>